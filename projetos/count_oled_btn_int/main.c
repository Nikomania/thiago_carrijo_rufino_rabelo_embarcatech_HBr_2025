#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <ctype.h>
#include <string.h>
#include "pico/stdlib.h"
#include "pico/binary_info.h"
#include "inc/ssd1306.h"
#include "hardware/i2c.h"

#define MAX_LINES 8
#define CHAR_HEIGHT 8
#define MAX_CHAR 16
#define I2C_SDA 14
#define I2C_SCL 15

#define BTN_A_PIN 5
#define BTN_B_PIN 6
#define BTN_DEBOUNCE_MS 35 // ms

#define COUNTDOWN_PERIOD 1000 // ms

#define FPS 120
#define FPS_PERIOD (1000 / FPS) // ms

// ssd1306_width pixels por ssd1306_n_pages p치ginas
struct render_area frame_area = {
    start_column : 0,
    end_column : ssd1306_width - 1,
    start_page : 0,
    end_page : ssd1306_n_pages - 1
};

struct button_state {
  absolute_time_t last_press_time;
  bool was_pressed;
  int btn_pin;
};

bool btn_b_count_enable = false;
int btn_b_click_count = 0;
int btn_a_countdown = 0;

struct button_state btn_A_state = {0, false, BTN_A_PIN};
struct button_state btn_B_state = {0, false, BTN_B_PIN};


uint8_t ssd[ssd1306_buffer_length];

void init_OLed();
void init_gpio();

void update_button_state(struct button_state *btn_state);
void gpio_callback(uint gpio, uint32_t event_mask);
bool countdown_callback(struct repeating_timer *t);

void center_c_str(char *str);
void get_c_string_from_int(int n, char *str);

void print_lines_OLed(char **text, unsigned int n_lines, int x0, int y0);
void clear_OLed();


int main() {
    stdio_init_all();

    init_OLed();
    clear_OLed();

    init_gpio();

    struct repeating_timer timer;

    while(true) {
        bool btn_A_clicked = btn_A_state.was_pressed;
        bool btn_B_clicked = btn_B_state.was_pressed;

        if (btn_A_clicked) {
            btn_A_state.was_pressed = false;
            btn_b_click_count = 0;
            btn_a_countdown = 9;
            if (!btn_b_count_enable)
                add_repeating_timer_ms(COUNTDOWN_PERIOD, countdown_callback, NULL, &timer);
            btn_b_count_enable = true;
        }

        if (btn_B_clicked) {
            btn_B_state.was_pressed = false;
            if (btn_b_count_enable) {
                btn_b_click_count++;
            }
        }

        char countdown_str[17] = "               ";
        get_c_string_from_int(btn_a_countdown, countdown_str);
        center_c_str(countdown_str);

        char count_b_str[17] = "               ";
        get_c_string_from_int(btn_b_click_count, count_b_str);
        center_c_str(count_b_str);

        const unsigned int n_lines = 8;
        char* o_led_text[] = {
            "   COUNTDOWN    ",
            countdown_str,
            "                ",
            "                ",
            "                ",
            "                ",
            "  BTN B COUNT   ",
            count_b_str
        };
        clear_OLed();
        print_lines_OLed(o_led_text, n_lines, 0, 0);
        render_on_display(ssd, &frame_area);
        sleep_ms(FPS_PERIOD);
    }

    return 0;
}

void update_button_state(struct button_state *btn_state) {
  if (
    !btn_state->was_pressed &&
    absolute_time_diff_us(btn_state->last_press_time, get_absolute_time()) > BTN_DEBOUNCE_MS * 1000
  ) {
    btn_state->last_press_time = get_absolute_time();
    btn_state->was_pressed = true;
  }
}

void gpio_callback(uint gpio, uint32_t event_mask) {
    switch (gpio) {
        case BTN_A_PIN:
            update_button_state(&btn_A_state);
            break;
        case BTN_B_PIN:
            update_button_state(&btn_B_state);
            break;
    }
}

void center_c_str(char* str) {
    const int white_spaces = (MAX_CHAR - strlen(str)) >> 1;
    if (white_spaces <= 0) {
        return;
    }
    for (int i = strlen(str); i >= 0; i--) {
        str[i + white_spaces] = str[i];
        str[i] = ' ';
    }
}

void get_c_string_from_int(int n, char* str) {
    snprintf(str, sizeof(str), "%d", n);
}

void print_lines_OLed(char** text, unsigned int n_lines, int x0, int y0) {
    if (n_lines > MAX_LINES || y0 + n_lines * 8 > ssd1306_height) {
        printf("OLed lines exceeded (%d)\n", MAX_LINES);
        return;
    }
    int y = y0;
    for (uint i = 0; i < n_lines; i++) {
        ssd1306_draw_string(ssd, x0, y, text[i]);
        y += CHAR_HEIGHT;
    }
}

void clear_OLed() {
    memset(ssd, 0, ssd1306_buffer_length);
}

void init_OLed() {
    i2c_init(i2c1, ssd1306_i2c_clock * 1000);
    gpio_set_function(I2C_SDA, GPIO_FUNC_I2C);
    gpio_set_function(I2C_SCL, GPIO_FUNC_I2C);
    gpio_pull_up(I2C_SDA);
    gpio_pull_up(I2C_SCL);

    // init do OLED SSD1306
    ssd1306_init();

    calculate_render_area_buffer_length(&frame_area);
}

void init_gpio() {
    gpio_init(BTN_A_PIN);
    gpio_set_dir(BTN_A_PIN, GPIO_IN);
    gpio_pull_up(BTN_A_PIN);

    gpio_init(BTN_B_PIN);
    gpio_set_dir(BTN_B_PIN, GPIO_IN);
    gpio_pull_up(BTN_B_PIN);

    gpio_set_irq_enabled_with_callback(BTN_A_PIN, GPIO_IRQ_EDGE_FALL, true, gpio_callback);
    gpio_set_irq_enabled_with_callback(BTN_B_PIN, GPIO_IRQ_EDGE_FALL, true, gpio_callback);
}

bool countdown_callback(struct repeating_timer *t) {
    if (btn_a_countdown > 0) {
        btn_a_countdown--;
    } else {
        btn_b_count_enable = false;
        cancel_repeating_timer(t);
    }
    return true;
}

// AFTER INIT OLED
// Parte do c칩digo para exibir a mensagem no display (opcional: mudar ssd1306_height para 32 em ssd1306_i2c.h)
    // /**

    // char value[17];
    // get_c_string_from_int(12, value);

    // const unsigned int n_lines = 2;
    // char* text[] = {
    //     value,
    //     "A Embarcatech BA"
    // };

    // print_lines_OLed(text, n_lines, 0, 0);
    // */

    // Parte do c칩digo para exibir a linha no display (algoritmo de Bresenham)
    /**
        ssd1306_draw_line(ssd, 10, 10, 100, 50, true);
        render_on_display(ssd, &frame_area);
    */

    // Parte do c칩digo para exibir o bitmap no display
    /**
        const uint8_t bitmap_128x64[] = { 
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xaa,0xaa,0xaa,0xaa,0xaa,0x0a,0x00,0x00,0x10,
    0x11,0x11,0x11,0x11,0x11,0x00,0x00,0x4a,0x4a,0x4a,0x4a,0x4a,0x0a,0x00,0x00,
    0x20,0x21,0x21,0x21,0x21,0x01,0x00,0x00,0x4a,0x94,0x94,0x94,0x94,0x04,0x00,
    0x00,0x10,0x21,0x22,0x22,0x22,0x12,0x00,0x00,0x4a,0x4a,0x44,0x44,0x44,0x04,
    0x00,0x00,0x90,0x90,0x92,0x92,0x92,0x02,0x00,0x00,0x22,0x25,0x24,0x24,0x24,
    0x14,0x00,0x00,0x14,0x92,0x92,0x92,0x92,0x02,0x00,0x00,0x00,0x00,0x48,0x04,
    0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x80,
    0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
    0x50,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x84,0x04,0x00,0x00,0x00,0x00,0x00,
    0x00,0x28,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x94,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x04,0x00,0x00,0x00,
    0x00,0x00,0x00,0x48,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0x00,0x00,
    0x00,0x00,0x00,0x00,0x40,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x02,0x00,
    0x00,0x00,0x00,0x00,0x00,0xa4,0x04,0x00,0x00,0x00,0x00,0x20,0x92,0x48,0x92,
    0x24,0x09,0x00,0x00,0x4a,0x49,0x92,0x48,0x92,0x04,0x00,0x00,0x10,0x84,0x44,
    0x22,0x44,0x10,0x00,0x00,0x4a,0x51,0x12,0x89,0x12,0x05,0x00,0x00,0x10,0x8a,
    0x48,0x52,0xa4,0x08,0x00,0x00,0x4a,0x11,0x91,0x88,0x08,0x05,0x00,0x00,0x20,
    0xa2,0x24,0x22,0xa5,0x10,0x00,0x00,0x4a,0x49,0x92,0x94,0x10,0x0a,0x00,0x00,
    0x10,0x12,0x49,0x22,0x4a,0x01,0x00,0x00,0xa0,0x24,0x22,0x89,0x10,0x02,0x00,
    0x00,0x10,0x91,0x88,0x50,0x4a,0x01,0x00,0x00,0x40,0x24,0x25,0x8a,0x24,0x00,
    0x00,0x00,0x80,0x92,0x48,0x11,0x91,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x01,0x24,0x04,0x00,0x00,0x00,0x00,
    0x4a,0x02,0x88,0x02,0x00,0x00,0x00,0x00,0x90,0x00,0x24,0x09,0x00,0x00,0x00,
    0x00,0x24,0x02,0x48,0x04,0x00,0x00,0x00,0x00,0x88,0x04,0x22,0x01,0x00,0x00,
    0x00,0x00,0x52,0x02,0x88,0x14,0x00,0x00,0x00,0x00,0x84,0x00,0x24,0x01,0x00,
    0x00,0x00,0x00,0x50,0x02,0x48,0x0a,0x00,0x00,0x00,0x00,0x24,0x04,0x24,0x00,
    0x00,0x00,0x00,0x00,0x84,0x02,0x90,0x0a,0x00,0x00,0x00,0x00,0x28,0x01,0x44,
    0x02,0x10,0x00,0x00,0x00,0x44,0x00,0x28,0x09,0x00,0x00,0x00,0x01,0x90,0x00,
    0x40,0x04,0x20,0x00,0x80,0x00,0x48,0x00,0x14,0x01,0x40,0x00,0x00,0x00,0x00,
    0x00,0xa0,0x00,0x90,0x00,0x40,0x01,0x00,0x00,0x00,0x00,0x20,0x00,0x20,0x02,
    0x00,0x00,0x00,0x00,0x40,0x01,0x40,0x01,0x00,0x00,0x00,0x00,0x10,0x02,0x28,
    0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x40,0x05,0x00,0x00,0x00,0x00,0x08,0x05,
    0x10,0x02,0x00,0x00,0x00,0x00,0x50,0x02,0xa0,0x08,0x00,0x20,0x00,0x00,0x24,
    0x01,0x10,0x25,0x00,0x00,0x00,0x00,0x92,0x00,0x40,0x48,0x00,0xa8,0x00,0x00,
    0x09,0x00,0x80,0x92,0x02,0x45,0x00,0x40,0xa4,0x00,0x40,0x24,0x54,0x28,0x05,
    0x00,0x11,0x00,0x00,0x89,0x22,0x05,0x00,0x00,0x44,0x00,0x00,0x22,0x94,0x08,
    0x00,0x00,0x28,0x00,0x00,0x49,0x21,0x01,0x00,0x00,0x00,0x00,0x00,0x24,0x8a,
    0x04,0x00,0x00,0x14,0x00,0x00,0x88,0x24,0x00,0x00,0x00,0x08,0x00,0x00,0x24,
    0x91,0x00,0x00,0x00,0x04,0x00,0x00,0x90,0x24,0x01,0x00,0x00,0x00,0x00,0x00,
    0x20,0x49,0x00,0x00,0x00,0x04,0x00,0x00,0x10,0x22,0x80,0xaa,0xaa,0x02,0x00,
    0x00,0x40,0x89,0x00,0x00,0x40,0x00,0x00,0x00,0x80,0x24,0x80,0xaa,0x2a,0x01,
    0x00,0x00,0x40,0x48,0x00,0x92,0x44,0x00,0x00,0x00,0x00,0x25,0x80,0x24,0x09,
    0x00,0x00,0x00,0x00,0x91,0x00,0x11,0x52,0x00,0x00,0x00,0x00,0x44,0x00,0xa2,
    0x08,0x00,0x00,0x00,0x00,0x29,0x80,0x14,0x05,0x00,0x00,0x00,0x00,0x84,0x00,
    0x21,0x10,0x00,0x00,0x00,0x00,0x50,0x00,0x4a,0x05,0x00,0x00,0x00,0x00,0x08,
    0x80,0x10,0x01,0x00,0x00,0x00,0x00,0x50,0x11,0xa5,0x04,0x00,0x00,0x00,0x00,
    0x80,0xa4,0x08,0x02,0x00,0x00,0x00,0x00,0x50,0x12,0x52,0x01,0x00,0x00,0x00,
    0x00,0x00,0x49,0x09,0x00,0x00,0x00,0x00,0x00,0x40,0x84,0xa4,0x00,0x00,0x00,
    0x00,0x00,0x80,0x52,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x25,0x00,0x00,
    0x00,0x00,0x00,0x00,0xa5,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x11,0x00,
    0x00,0x00,0x00,0x00,0x00,0x52,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x84,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x10,
    0x01,0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00 };

        ssd1306_t ssd_bm;
        ssd1306_init_bm(&ssd_bm, 128, 64, false, 0x3C, i2c1);
        ssd1306_config(&ssd_bm);

        ssd1306_draw_bitmap(&ssd_bm, bitmap_128x64);
    */
